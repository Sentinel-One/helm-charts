apiVersion: {{ template "daemonset.apiVersion" . }}
kind: DaemonSet
metadata:
  name: {{ include "agent.fullname" . }}
  labels: {{- include "sentinelone.agent.labels" . | nindent 4 }}
spec:
  updateStrategy:
    type: {{ default "RollingUpdate" .Values.agent.updateStrategy }}
  selector:
    matchLabels:
{{- include "sentinelone.agent.selector.labels" . | nindent 6 }}
  template:
    metadata:
      labels:
{{- include "sentinelone.agent.labels" . | nindent 8 }}
      annotations:
      {{- if .Values.agent.podAnnotations }}
{{ toYaml .Values.agent.podAnnotations | indent 8 }}
      {{- end }}
        {{ default "container.apparmor.security.beta.kubernetes.io/agent" .Values.agent.apparmorAnnotation }}: {{ default "unconfined" .Values.agent.apparmorPolicy }}
    spec:
{{- if .Values.secrets.imagePullSecret }}
      imagePullSecrets:
        - name: {{ .Values.secrets.imagePullSecret }}
{{- end }}
      hostPID: true
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      securityContext:
        runAsUser: {{ .Values.configuration.env.agent.pod_uid }}
        runAsGroup: {{ .Values.configuration.env.agent.pod_gid }}
      restartPolicy: Always
      serviceAccountName: {{ include "sentinelone.serviceAccountName" . }}
      containers:
      - name: agent
        image: "{{ include "agent.full_url" . }}"
        imagePullPolicy: {{ default "IfNotPresent" .Values.configuration.imagePullPolicy }}
        resources:
{{ toYaml .Values.agent.resources | indent 10 }}
        env:
{{- include "agent.common_env" . | nindent 8 }}
{{- if include "site_key.secret.name" . }}
        - name: SITE_TOKEN
          valueFrom:
            secretKeyRef:
              name: {{ include "site_key.secret.name" . }}
              key: site-key
{{- end }}
        - name: S1_AGENT_TYPE
          value: "k8s"
        - name: S1_HELPER_CRT
          valueFrom:
            secretKeyRef:
              name: {{ include "helper.secret.name" . }}
              key: tls.crt
        - name: S1_HELPER_HOST
          value: {{ include "service.name" . }}
        - name: S1_AGENT_HOST_MOUNT_PATH
          value: "{{ default "/host" .Values.configuration.env.agent.host_mount_path }}"
        - name: S1_PERSISTENT_DIR
          value: "{{ default "/var/lib/sentinelone" .Values.configuration.env.agent.persistent_dir }}"
        - name: S1_POD_UID
          value: "{{ .Values.configuration.env.agent.pod_uid }}"
        - name: S1_POD_GID
          value: "{{ .Values.configuration.env.agent.pod_gid }}"
        - name: S1_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: S1_POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
{{- if .Values.configuration.custom_ca }}
{{- range $path, $_ := .Files.Glob "files/*.pem" }}
          - name: ca-certs
            mountPath: "/usr/local/share/ca-certificates/{{ base $path }}"
            subPath: "{{ base $path }}"
{{- end }}
{{- end }}
          - name: debugfs
            mountPath: /sys/kernel/debug/
          - name: modules
            mountPath: /lib/modules/
          - name: host
            mountPath: {{ default "/host" .Values.configuration.env.agent.host_mount_path }}
            mountPropagation: HostToContainer
        securityContext:
          capabilities:
            drop:
              - all
            add: {{ toYaml .Values.agent.capabilities | nindent 14 }}
      volumes:
{{- if .Values.configuration.custom_ca }}
        - name: ca-certs
          secret:
            secretName: "{{ include "agent.fullname" . }}-custom-ca"
{{- end }}
        - name: debugfs
          hostPath:
            path: /sys/kernel/debug/
        - name: modules
          hostPath:
            path: /lib/modules/
        - name: host
          hostPath:
            path: /
    {{- with .Values.agent.nodeSelector }}
      nodeSelector: {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- if default .Values.helper.priorityClassName .Values.agent.priorityClassName }}
      priorityClassName: {{ default .Values.helper.priorityClassName .Values.agent.priorityClassName }}
    {{- end }}
    {{- with .Values.agent.affinity }}
      affinity: {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- with .Values.agent.tolerations }}
      tolerations: {{- toYaml . | nindent 8 }}
    {{- end }}
